#! /bin/sh
BATC=./sys/class/power_supply/BAT1/capacity
BATS=./sys/class/power_supply/BAT1/status

function expandstr {
	if [ $# -gt 1 ]; then
		export COMP=$(expr $2 - ${#1})
		comp_str=$(perl -e 'print(" "x$ENV{COMP})')
		echo "$1$comp_str"
	elif [ $# -gt 0 ]; then
		export COMP=$1
		comp_str=$(perl -e 'print(" "x$ENV{COMP})')
		echo "$comp_str"
	fi
}	

function username {
	echo $USER
}

function get_window {
	winid=$(bspc query -D -d)
	ismain=$(eval $($winid == 0x00800003))
	isdev=$(eval $($winid == 0x00800004))
	isweb=$(eval $($winid == 0x00800005))
	
	if [[ $ismain == true ]]; then
		echo "main"
	elif [[ $isdev == true ]]; then
		echo "dev"
	elif [[ $isweb == true ]]; then
		echo "web"
	else
		echo "etc"
	fi
}


function window_icon {
	if [[ "$1" == 'urxvt' ]]; then	
		echo -e "\uf120"
	elif [[ "$1" == 'chrome' ]]; then
		echo -e "\uf268"
	elif [[ "$1" == 'firefox' ]]; then
		echo -e "\uf269"
	elif [[ "$1" == 'desktop' ]]; then
		echo -e "\uf108"
	elif [[ "$1" == 'nautilus' ]]; then
		echo -e "\uf07b"
	elif [[ "$1" == 'atom' ]]; then
		echo -e "\uf121"
	else	
		echo -e "\uf17c"
	fi
}
function window {	
	wnd_focus=$(xdotool getwindowfocus)                                                                                                                         
	wnd_title=$(xprop -id $wnd_focus WM_CLASS |\
		  grep -Po "\".*?\"" |\
		  head -1 |\
		  grep -Po "[^\"]*")

	if [[ "$wnd_title" == 'Navigator' ]]; then
		wnd_title='firefox'
	elif [[ "$wnd_title" == 'google-chrome' ]]; then
		wnd_title='chrome'
	elif [[ "$wnd_title" == '' ]]; then
		wnd_title='desktop'
	fi

	echo -e "%{U#237889}%{O20}$(window_icon $wnd_title) $(expandstr $wnd_title 15)%{U-}"
}

function timeday {
	echo $(clock | grep -o "[0-9]*:[0-9]*")
}

function battery {
	batlvl="$(upower -i /org/freedesktop/UPower/devices/battery_BAT1 |\
		    grep -oE "[0-9]*%" |\
		    grep -oP "\d*" |\
		    head -1)"

	charging="$(upower -i /org/freedesktop/UPower/devices/battery_BAT1 |\
		    grep "state: *charging\|state: *fully")"
	state=""
	if [[ ${#charging} -gt 0 ]]; then
		state="%{F#22CDA1}"
	fi

	if [[ $batlvl -gt 87 ]]; then
		echo "$state\uf240%{F-}"
	elif [[ $batlvl -gt 63 ]]; then
		echo "$state\uf241%{F-}"
	elif [[ $batlvl -gt 37 ]]; then
		echo "$state\uf242%{F-}"
	elif [[ $batlvl -gt 13 ]]; then
		echo "$state\uf243%{F-}"
	else
		echo "$state\uf244%{F-}"
	fi
}

function active {
	echo "\uf111 \uf10c"
}

while [ 1 -gt 0 ]; do
	
	f="%{l}%{O10}$(window)"
	c="%{c}"
	b="%{r}$(battery) $(timeday)%{O10}"

	echo -e "$f$c$b"
	sleep .1
done
